# Настройка прав доступа для работы без sudo

## Проблема

Для работы `tap-launcher` с подавлением клавиш через `evdev+uinput` требуется доступ к:
1. `/dev/input/event*` - чтение событий клавиатуры ✅ (доступно через группу `input`)
2. `/dev/uinput` - создание виртуальных устройств ❌ (требует root)

## Решение: udev правило для uinput

### Почему это лучший вариант?

- ✅ **Просто для пользователя**: одна команда для установки правила
- ✅ **Безопасно**: использует стандартную группу `input`, которая уже используется для `/dev/input/event*`
- ✅ **Перманентно**: правило применяется автоматически при каждой загрузке
- ✅ **Не требует systemd**: можно запускать как обычное приложение
- ✅ **Стандартно**: это стандартный подход для многих Linux-проектов

### Пошаговая инструкция

#### Вариант 1: Ручная установка (рекомендуется)

1. **Создайте файл правила udev:**

```bash
sudo tee /etc/udev/rules.d/99-uinput.rules > /dev/null << 'EOF'
# Разрешить группе input доступ к uinput для создания виртуальных устройств
KERNEL=="uinput", MODE="0660", GROUP="input"
EOF
```

2. **Примените правило без перезагрузки:**

```bash
sudo udevadm control --reload-rules
sudo udevadm trigger
```

3. **Проверьте права:**

```bash
ls -l /dev/uinput
# Должно показать: crw-rw---- 1 root input ... /dev/uinput
```

4. **Проверьте, что пользователь в группе input:**

```bash
groups | grep input
# Должна быть строка с "input"
```

Если пользователя нет в группе `input`:
```bash
sudo usermod -a -G input $USER
# Затем нужно выйти и войти снова, или выполнить:
newgrp input
```

5. **Протестируйте доступ:**

```bash
python3 -c "from evdev import UInput; from evdev import ecodes as e; ui = UInput({e.EV_KEY: [e.KEY_A]}); print('✅ uinput доступен!'); ui.close()"
```

Если ошибка "Permission denied", попробуйте:
- Выйти и войти в систему снова (чтобы группы применились)
- Или временно: `sudo chmod 666 /dev/uinput` (не рекомендуется для постоянного использования)

#### Вариант 2: Автоматическая установка (для разработки)

Можно добавить в `tap-launcher` команду для проверки и установки правил.

### Альтернативные варианты (не рекомендуется)

#### ❌ Systemd user service
- **Проблема**: systemd user service всё равно запускается от имени пользователя без root-прав
- **Не решает проблему**: права на `/dev/uinput` нужно настраивать через udev в любом случае
- **Использование**: только для автозапуска, но не для решения проблемы прав

#### ❌ Polkit или setuid
- **Сложнее**: требует дополнительной настройки
- **Менее стандартно**: не является стандартным подходом для uinput

#### ❌ Запуск через sudo
- **Небезопасно**: дает полный root-доступ
- **Неудобно**: требует sudo для каждого запуска

## Проверка работы

После настройки прав, протестируйте:

```bash
# Проверка доступа к event устройствам
python3 -c "import evdev; print(f'✅ Найдено устройств: {len(evdev.list_devices())}')"

# Проверка доступа к uinput
python3 -c "from evdev import UInput; from evdev import ecodes as e; ui = UInput({e.EV_KEY: [e.KEY_A]}); print('✅ uinput работает!'); ui.close()"

# Запуск теста подавления
python3 docs/20251029-200001-proposal-key_suppression/test_key_suppression_evdev.py
```

## Безопасность

Доступ к группе `input` предоставляет:
- ✅ Чтение всех событий клавиатуры и мыши
- ✅ Создание виртуальных устройств ввода
- ⚠️ Потенциальная возможность перехвата ввода

**Это стандартный уровень доступа**, используемый:
- Desktop окружениями (KDE, GNOME)
- X11 серверами
- Wayland compositors
- Множеством других системных утилит

Если это вызывает опасения, можно рассмотреть более изолированное решение, но это потребует значительной переработки архитектуры.

## Устранение проблем

### "Permission denied" при доступе к uinput

1. Проверьте, что правило создано:
   ```bash
   cat /etc/udev/rules.d/99-uinput.rules
   ```

2. Проверьте, что правило применено:
   ```bash
   sudo udevadm test /sys/class/misc/uinput 2>&1 | grep -i "permission"
   ```

3. Убедитесь, что устройство существует:
   ```bash
   ls -l /dev/uinput
   ```

4. Перезагрузите систему (самый надежный способ применить правила)

### Пользователь не в группе input

```bash
# Добавить пользователя в группу
sudo usermod -a -G input $USER

# Применить изменения без перезагрузки (временное решение)
newgrp input

# Проверить
groups | grep input
```

**Важно**: Изменения групп применяются только при новой сессии. После `usermod` нужно:
- Выйти и войти снова, ИЛИ
- Выполнить `newgrp input` (временное решение для текущей сессии)

